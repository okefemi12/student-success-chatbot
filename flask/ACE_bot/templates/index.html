<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ACE ‚Äî AI Study Assistant</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { font-family: system-ui, sans-serif; color:#111; }
    body { max-width:1200px; margin:18px auto; padding:16px; background:#f5f5f5; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; background:white; padding:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    h1 { margin:0; font-size:22px; color:#007cba; }
    .grid { display:grid; grid-template-columns: 1fr 500px; gap:16px; align-items:start; }
    section { border:1px solid #e6e6e6; padding:16px; border-radius:8px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:12px; }
    .hidden { display:none; }
    label{font-size:13px;display:block;margin-top:10px;font-weight:500;color:#333;}
    input, select, textarea { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    button { padding:10px 16px; margin:6px 4px; border-radius:6px; cursor:pointer; border:none; background:#007cba; color:white; font-weight:500; transition:background 0.2s; }
    button:hover { background:#005a8c; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    .small { padding:6px 10px; font-size:13px; }
    .danger { background:#ff6b6b; }
    .danger:hover { background:#ff5252; }
    .secondary { background:#6c757d; }
    .secondary:hover { background:#5a6268; }
    .success { background:#28a745; }
    .success:hover { background:#218838; }
    .chat-box { height:auto; display:flex; flex-direction:column; gap:8px; }
    .messages { border:1px solid #ddd; padding:12px; height:400px; overflow:auto; border-radius:6px; background:#fafafa; }
    .message { margin-bottom:12px; padding:8px; border-radius:6px; }
    .message.user { text-align:right; background:#e3f2fd; color:#1565c0; margin-left:20%; }
    .message.assistant { text-align:left; background:#f1f8e9; color:#558b2f; margin-right:20%; }
    .controls { display:flex; gap:8px; align-items:center; }
    .session-list { max-height:180px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:6px; background:#fafafa; }
    .session-item { padding:8px; border-bottom:1px dashed #e0e0e0; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .session-item:last-child{border-bottom:none}
    .session-item:hover { background:#f5f5f5; }
    .right { text-align:right; }
    .status { font-size:13px; color:#666; margin-top:8px; padding:8px; background:#f8f9fa; border-radius:4px; }
    pre#backend { white-space:pre-wrap; word-break:break-word; background:#f7f7f7; padding:12px; border-radius:6px; max-height:200px; overflow:auto; font-size:12px; }
    .flashcard { border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .quiz-container { border:1px solid #ddd; padding:16px; margin:8px 0; border-radius:6px; background:#fff; }
    .quiz-question { margin-bottom:12px; font-weight:bold; font-size:15px; }
    .quiz-option { margin:6px 0; padding:8px; border-radius:4px; transition:background 0.2s; }
    .quiz-option:hover { background:#f5f5f5; }
    .quiz-option input { width:auto; margin-right:10px; }
    .quiz-results { background:#e8f5e8; padding:12px; border-radius:6px; margin-top:12px; }
    .summary-item, .recommendation-item { border:1px solid #eee; padding:12px; margin:8px 0; border-radius:6px; background:#fff; }
    .tabs { display:flex; gap:4px; margin-bottom:12px; border-bottom:2px solid #e0e0e0; }
    .tab { padding:10px 16px; border:none; border-radius:6px 6px 0 0; cursor:pointer; background:#f5f5f5; font-weight:500; transition:all 0.2s; }
    .tab.active { background:#007cba; color:white; }
    .tab:hover:not(.active) { background:#e0e0e0; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .reminder-item { border-left:4px solid #007cba; padding:12px; margin:8px 0; background:#f8f9fa; border-radius:4px; }
    .reminder-item.completed { border-left-color:#28a745; background:#f1f8f1; }
    .stats-card { padding:16px; border-radius:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; margin:8px 0; }
    .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; margin:2px; }
    .badge-primary { background:#007cba; color:white; }
    .badge-success { background:#28a745; color:white; }
    .badge-warning { background:#ffc107; color:#333; }
    .prediction-card { padding:16px; border-radius:8px; margin:12px 0; }
    .prediction-pass { background:#d4edda; border:2px solid #28a745; }
    .prediction-fail { background:#f8d7da; border:2px solid #dc3545; }
    .video-card { border:1px solid #e0e0e0; padding:12px; margin:8px 0; border-radius:6px; background:#fff; }
    .video-card:hover { box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    .library-item { border: 1px solid #e0e0e0; padding: 12px; margin: 8px 0; border-radius: 6px; background: #fff;box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
    .library-item:hover {box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
    .file-link {display: inline-block;padding: 4px 8px;margin: 4px 4px 4px 0;background: #e3f2fd;border-radius: 4px;text-decoration: none;color: #1565c0;font-size: 13px;transition: background 0.2s;}
    .file-link:hover {background: #bbdefb;}
    .file-type-badge {display: inline-block;padding: 2px 6px;margin-left: 4px;background: #f5f5f5;border-radius: 3px;font-size: 11px;color: #666;text-transform: uppercase;}
    .upload-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.7);display: flex;flex-direction: column;align-items: center;justify-content: center;z-index: 10000;}
    .circular-progress {position: relative;width: 120px;height: 120px;}
    .circular-progress svg {transform: rotate(-90deg);}
    .progress-circle-bg {fill: none;stroke: #e0e0e0;stroke-width: 8;}
    .progress-circle {fill: none;stroke: #007cba;stroke-width: 8;stroke-linecap: round;transition: stroke-dashoffset 0.3s ease;}
    .progress-text {position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);font-size: 24px;font-weight: bold;color: white;}
    .upload-status-text {color: white;font-size: 16px;margin-top: 20px;text-align: center;}
    .spinner {border: 4px solid rgba(255, 255, 255, 0.3);border-top: 4px solid white;border-radius: 50%;width: 40px;height: 40px;animation: spin 1s linear infinite;margin: 20px auto;}
    @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
    .message-content {line-height: 1.6;}
    .message-content p {margin: 0 0 12px 0;}
    .message-content ul {margin: 8px 0;padding-left: 20px;}
    .message-content li {margin: 4px 0;}
    .message-content strong {font-weight: 600;color: #2c3e50;}
    .message-content em {font-style: italic;color: #34495e;}
    .message-content a {color: #007cba;text-decoration: none;border-bottom: 1px solid #007cba;transition: all 0.2s;}
    .message-content a:hover {color: #005a8c;border-bottom-color: #005a8c;}
    .audio-controls {border-top: 1px solid #e0e0e0;padding-top: 8px;margin-top: 12px;}
    .audio-status {font-size: 12px;color: #666;font-style: italic;}
    @keyframes blink {0%, 50% { opacity: 1; }51%, 100% { opacity: 0; }}
    .typing-cursor::after {content: '|';animation: blink 1s infinite;}
    .flip-card {
      background-color: transparent;
      perspective: 1000px;
      height: 200px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .flip-card:hover {
      transform: scale(1.02);
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .flip-card-front {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .flip-card-back {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      transform: rotateY(180deg);
    }

    .flip-card-front:hover,
    .flip-card-back:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    .image-gallery-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .image-gallery-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .image-gallery-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      cursor: pointer;
    }

    .image-gallery-item .image-info {
      padding: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .image-gallery-item .image-prompt {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .image-gallery-item .image-date {
      font-size: 11px;
      color: #999;
      margin-bottom: 8px;
    }
  </style>
  

  </style>
</head>
<body>
  <header>
    <h1>üéì ACE ‚Äî AI Study Assistant</h1>
    <div>
      <button id="btn-go-chat" class="small secondary">Chat</button>
      <button id="btn-go-profile" class="small secondary">Profile</button>
      <button id="btn-go-library" class="small secondary">Library</button>
      <button id="btn-logout-top" class="small danger">Logout</button>
    </div>
  </header>

  <div class="grid">

    <!-- LEFT COLUMN -->
    <div>

      <!-- AUTH SECTION -->
      <section id="auth-section">
        <h2>üîê Sign up / Login</h2>
        <div style="display:flex; gap:16px;">
          <div style="flex:1">
            <h3>Sign up</h3>
            <label>Full name *</label><input id="signup-name" placeholder="Jane Doe" />
            <label>Email *</label><input id="signup-email" type="email" />
            <label>Password *</label><input id="signup-password" type="password" placeholder="6+ characters" />
            <label>Date of Birth *</label><input id="signup-dob" type="date" />
            <label>Gender *</label>
            <select id="signup-gender"><option value="">-- select --</option><option>Male</option><option>Female</option><option>Other</option></select>
            <label>Phone Number *</label><input id="signup-phone" type="tel" placeholder="+234..." />
            <label>Country</label><input id="signup-country" placeholder="Nigeria" />
            <label>School Type</label><input id="signup-school-type" placeholder="University" />
            <label>School Name</label><input id="signup-school-name" placeholder="University of Lagos" />
            <label>Degree</label><input id="signup-degree" placeholder="Bachelor's" />
            <label>Course of Study</label><input id="signup-course" placeholder="Computer Science" />
            <label>Subject(s)</label><input id="signup-subject" placeholder="Mathematics, Physics" />
            <div style="margin-top:12px;">
              <button id="btn-signup">Sign up</button>
              <button id="btn-google" class="secondary">üîç Google Sign in</button>
            </div>
            <div style="margin-top:12px; padding:12px; background:#f8f9fa; border-radius:6px;">
              <label style="font-size:14px; font-weight:500; color:#333;">Reset Password</label>
              <input id="forgot-email" type="email" placeholder="Enter your email" style="margin-top:6px;" />
              <button id="btn-forgot" type="button" class="secondary" style="margin-top:6px; width:100%;">Send Reset Link</button>
            </div>
          </div>

          <div style="flex:1">
            <h3>Login</h3>
            <label>Email</label><input id="login-email" type="email" />
            <label>Password</label><input id="login-password" type="password" />
            <div style="margin-top:12px;">
              <button id="btn-login">Login</button>
              <button id="btn-forgot" type="button" class="secondary">Forgot Password?</button>
              <button id="btn-logout" class="danger">Logout</button>
            </div>
            <div class="status" id="status">Not initialized</div>
          </div>
        </div>
      </section>

      <!-- PROFILE SECTION -->
      <section id="profile-section" class="hidden">
        <h2>üë§ Your Profile</h2>
        <label>Name</label><input id="profile-name" />
        <label>Date of Birth</label><input id="profile-dob" type="date" />
        <label>Gender</label>
        <select id="profile-gender"><option value="">-- select --</option><option>Male</option><option>Female</option><option>Other</option></select>
        <label>Phone Number</label><input id="profile-phone" />
        <label>Country</label><input id="profile-country" />
        <label>School Type</label><input id="profile-school-type" />
        <label>School Name</label><input id="profile-school-name" />
        <label>Degree</label><input id="profile-degree" />
        <label>Course of Study</label><input id="profile-course" />
        <label>Subject(s)</label><input id="profile-subject" />
        <div style="margin-top:12px;">
          <button id="btn-update-profile" class="success">Update Profile</button>
          <button id="btn-delete-account" class="danger">Delete Account</button>
        </div>
      </section>

      <!-- STUDY SESSION -->
      <section id="study-section" class="hidden">
        <h2>üìö Study Session Tracker</h2>
        <div>
          <button id="btn-start-session" class="success">‚ñ∂ Start Session</button>
          <button id="btn-end-session" class="danger" disabled>‚èπ End Session</button>
        </div>
        <p id="study-status" class="status">No active session</p>
      </section>

      <!-- PERFORMANCE PREDICTION -->
      <section id="prediction-section" class="hidden">
        <h2>üéØ Performance Prediction</h2>
        <button id="btn-predict-performance">Predict My Performance</button>
        <div id="prediction-result"></div>
      </section>

      <!-- GAMIFICATION -->
      <section id="gamification-section" class="hidden">
        <h2>üèÜ Your Progress</h2>
        <button id="btn-refresh-gamification">Refresh Stats</button>
        <div id="gamification-stats"></div>
      </section>

      <!-- REMINDERS -->
      <section id="reminders-section" class="hidden">
        <h2>‚è∞ Study Reminders</h2>
        <label>Title</label><input id="reminder-title" />
        <label>Description</label><textarea id="reminder-desc" rows="2"></textarea>
        <label>Start Date</label><input id="start-date" type="date" />
        <label>Due Date</label><input id="reminder-date" type="date" />
        <label>Upload Files (PDFs or Images)</label>
        <input id="reminder-files" type="file" multiple accept=".pdf,image/*" />

        <div style="margin-top:10px;">
          <button id="btn-add-reminder">Add Reminder</button>
          <button id="btn-refresh-reminders" class="secondary">Refresh</button>
        </div>
        <h3 style="margin-top:12px;">Your Reminders</h3>
        <div id="reminder-list"></div>
      </section>

      <!-- RECOMMENDATIONS -->
      <section id="recommendations-section" class="hidden">
        <h2>üì∫ Content Recommendations</h2>
        <button id="btn-get-recommendations">Get Video Recommendations</button>
        <div id="recommendations-list"></div>
      </section>
      <!-- LIBRARY SECTION -->
    <section id="library-section" class="hidden">
      <h2>üìö My Library</h2>
      
      <!-- Upload Form -->
      <div style="border:1px solid #e0e0e0; padding:12px; border-radius:6px; background:#f9f9f9; margin-bottom:16px;">
        <h3 style="margin:0 0 12px 0;">Upload Documents</h3>
        <form id="library-upload-form" enctype="multipart/form-data">
          <label>Title *</label>
          <input id="library-title" type="text" placeholder="e.g., Linear Algebra Notes" required />
          
          <label>Files * (PDF, DOCX, Images, etc.)</label>
          <input id="library-files" type="file" multiple accept=".pdf,.docx,.pptx,.xlsx,.txt,.png,.jpg,.jpeg" required />
          
          <div style="margin-top:12px;">
            <button type="submit" class="success">üì§ Upload to Library</button>
            <button type="reset" class="secondary">Clear</button>
          </div>
        </form>
      </div>
      
      <!-- Library Items List -->
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">Your Documents</h3>
        <div>
          <button id="btn-refresh-library" class="small">Refresh</button>
          <button id="btn-delete-all-library" class="small danger">Delete All</button>
        </div>
      </div>
      
      <div id="library-list" style="max-height:400px; overflow-y:auto;">
        <div style="color:#666; text-align:center; padding:20px;">No documents yet</div>
      </div>
    </section>

    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <section class="chat-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0">üí¨ Study Tools</h2>
          <div>
            <button id="btn-new-session" class="small">New Chat</button>
            <button id="btn-clear-memory" class="small danger">Clear Memory</button>
          </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
          <div class="tab active" data-tab="chat">Chat</div>
          <div class="tab" data-tab="sessions">Sessions</div>
          <div class="tab" data-tab="flashcards">Flashcards</div>
          <div class="tab" data-tab="quiz">Quiz</div>
          <div class="tab" data-tab="summaries">Summaries</div>
        </div>

        <!-- CHAT TAB -->
        <div id="tab-chat" class="tab-content active">
          <div class="messages" id="messages-container" aria-live="polite"></div>

          <div class="controls" style="margin-top:8px;">
            <textarea id="message-input" placeholder="Ask me anything..." rows="2"></textarea>
            <button id="btn-send">Send</button>
          </div>

          <!-- Audio Recording -->
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button id="btn-start-recording" class="small">üé§ Record</button>
            <button id="btn-stop-recording" class="small danger" disabled>‚èπ Stop</button>
            <div id="recording-status" class="status" style="flex:1;"></div>
          </div>

          <!-- File Uploads -->
          <div style="margin-top:10px;">
            <form id="pdf-summary-form" enctype="multipart/form-data" style="margin-bottom:8px;">
              <input type="file" name="file" accept=".pdf,.docx,.pptx,.xlsx,.png,.jpg,.jpeg" />
              <button type="submit" class="small">üìÑ Doc Summary</button>
            </form>

            <form id="pdf-quiz-form" enctype="multipart/form-data" style="margin-bottom:8px;">
              <input type="file" name="file" accept=".pdf,.docx,.pptx,.xlsx,.png,.jpg,.jpeg" />
              <button type="submit" class="small">üìù Doc Quiz</button>
            </form>

            <form id="pdf-flashcard-form" enctype="multipart/form-data">
              <input type="file" name="file" accept=".pdf,.docx,.pptx,.xlsx,.png,.jpg,.jpeg" />
              <button type="submit" class="small">üÉè Doc Flashcards</button>
            </form>
          </div>

          <!-- Text Input Forms -->
          <form id="quiz-form" style="margin-top:10px;">
            <textarea id="quiz-input" placeholder="Paste text to generate quiz..." rows="2"></textarea>
            <button type="submit" class="small">Generate Quiz</button>
          </form>

          <form id="flashcard-form" style="margin-top:8px;">
            <textarea id="flashcard-input" placeholder="Paste text to generate flashcards..." rows="2"></textarea>
            <button type="submit" class="small">Generate Flashcards</button>
          </form>

          <div class="status" id="chat-status"></div>
        </div>

        <!-- SESSIONS TAB -->
        <div id="tab-sessions" class="tab-content">
          <h3>Chat Sessions</h3>
          <div style="margin-bottom:12px;">
            <input id="load-session-id" placeholder="Paste session ID to load..." />
            <button id="btn-load-session" class="small">Load Session</button>
          </div>
          <div class="session-list" id="local-sessions"></div>
        </div>

        <!-- FLASHCARDS TAB -->
        <div id="tab-flashcards" class="tab-content">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0">üÉè Flashcards</h3>
            <button id="btn-refresh-flashcards" class="small">Refresh</button>
          </div>
          <div id="flashcards-container" style="max-height:500px; overflow-y:auto;">
            <div style="color:#666; text-align:center; padding:20px;">No flashcards yet</div>
          </div>
        </div>

        <!-- QUIZ TAB -->
        <div id="tab-quiz" class="tab-content">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0">üìù Quizzes</h3>
            <button id="btn-refresh-quiz" class="small">Refresh</button>
          </div>
          <div id="quiz-container" style="max-height:500px; overflow-y:auto;">
            <div style="color:#666; text-align:center; padding:20px;">No quizzes yet</div>
          </div>
        </div>

        <!-- SUMMARIES TAB -->
        <div id="tab-summaries" class="tab-content">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0">üìÑ Summaries</h3>
            <button id="btn-refresh-summaries" class="small">Refresh</button>
          </div>
          <div id="summaries-container" style="max-height:500px; overflow-y:auto;">
            <div style="color:#666; text-align:center; padding:20px;">No summaries yet</div>
          </div>
        </div>
      </section>

      <section>
        <h3>üìä Backend Response</h3>
        <pre id="backend">‚Äî</pre>
      </section>
    </div>
  </div>

  <script id="firebase-config" type="application/json">{{ firebase_config | tojson | safe }}</script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

  const firebaseConfig = JSON.parse(document.getElementById("firebase-config").textContent);
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = id => document.getElementById(id);
  const logBackend = (o) => { try { $("backend").textContent = JSON.stringify(o, null, 2); } catch(e){} };

  let idTokenCache = null;
  let studyStart = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let currentSessionId = null;

  // Tab functionality
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      const tabId = 'tab-' + tab.dataset.tab;
      document.getElementById(tabId).classList.add('active');
    });
  });

  // Local session storage
  function getLocalSessions() {
    try { return JSON.parse(localStorage.getItem("chat_sessions_v1") || "[]"); } 
    catch (e) { return []; }
  }
  function saveLocalSessions(arr) {
    localStorage.setItem("chat_sessions_v1", JSON.stringify(arr || []));
  }
  function addLocalSession(obj) {
    const arr = getLocalSessions();
    const exists = arr.find(x => x.id === obj.id);
    if (!exists) arr.unshift(obj);
    saveLocalSessions(arr);
    renderLocalSessions();
  }
  function removeLocalSession(id) {
    const arr = getLocalSessions().filter(s => s.id !== id);
    saveLocalSessions(arr);
    renderLocalSessions();
  }
  function renderLocalSessions() {
    const container = $("local-sessions");
    container.innerHTML = "";
    const arr = getLocalSessions();
    if (arr.length === 0) { 
      container.innerHTML = "<div style='color:#666; padding:12px;'>No sessions yet</div>"; 
      return; 
    }
    arr.forEach(s => {
      const row = document.createElement("div");
      row.className = "session-item";
      row.innerHTML = `
        <div style="flex:1">
          <strong>${escapeHtml(s.title || 'Untitled')}</strong>
          <div style="font-size:11px;color:#999">${s.id.slice(0,16)}...</div>
        </div>
        <div style="display:flex;gap:6px">
          <button data-load="${s.id}" class="small">Load</button>
          <button data-delete="${s.id}" class="small danger">Delete</button>
        </div>`;
      container.appendChild(row);
    });

    container.querySelectorAll("button[data-load]").forEach(b=>{
      b.onclick = () => loadSessionById(b.getAttribute("data-load"));
    });
    container.querySelectorAll("button[data-delete]").forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute("data-delete");
        if (confirm("Remove session locally?")) removeLocalSession(id);
      };
    });
  }

  // API helper
  async function api(path, opts = {}) {
    opts.headers = opts.headers || {};
    const token = idTokenCache || localStorage.getItem("idToken");
    if (token) opts.headers["Authorization"] = "Bearer " + token;
    try {
      const res = await fetch(path, opts);
      const json = await res.json().catch(()=>({}));
      if (!res.ok && json && json.error) {
        return { error: json.error, status: res.status, ...json };
      }
      return json;
    } catch (err) {
      return { error: err.message || String(err) };
    }
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return "";
    return String(str).replace(/[&<>"']/g, s => ({ 
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  // ‚úÖ ADD THESE TWO FUNCTIONS HERE - Right after escapeHtml
  function parseAndFormatMessage(text) {
    // Convert **bold** to <strong>
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert *italic* to <em>
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert bullet points
    text = text.replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    
    // Convert URLs to clickable links
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    text = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    
    // Preserve line breaks
    text = text.replace(/\n\n/g, '</p><p>');
    text = text.replace(/\n/g, '<br>');
    
    return `<p>${text}</p>`;
  }

  // Typewriter effect function
  async function typewriterEffect(element, html, speed = 5) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    element.innerHTML = '';
    let currentIndex = 0;
    
    return new Promise((resolve) => {
      const interval = setInterval(() => {
        if (currentIndex < textContent.length) {
          const char = textContent[currentIndex];
          element.innerHTML += char === '\n' ? '<br>' : char;
          currentIndex++;
        } else {
          clearInterval(interval);
          // Replace with properly formatted HTML
          element.innerHTML = html;
          resolve();
        }
      }, speed);
    });
  }

  // Auth state handler
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      $("status").textContent = "‚úÖ Signed in: " + (user.email || user.uid);
      idTokenCache = await user.getIdToken(true);
      localStorage.setItem("idToken", idTokenCache);
      
      $("auth-section").classList.add("hidden");
      $("profile-section").classList.remove("hidden");
      $("reminders-section").classList.remove("hidden");
      $("study-section").classList.remove("hidden");
      $("prediction-section").classList.remove("hidden");
      $("gamification-section").classList.remove("hidden");
      $("recommendations-section").classList.remove("hidden");
      $("library-section").classList.remove("hidden");
      
      await loadProfile();
      renderLocalSessions();
      loadGamification();
    } else {
      $("status").textContent = "‚ùå Signed out";
      idTokenCache = null;
      localStorage.removeItem("idToken");
      
      $("auth-section").classList.remove("hidden");
      $("profile-section").classList.add("hidden");
      $("reminders-section").classList.add("hidden");
      $("study-section").classList.add("hidden");
      $("prediction-section").classList.add("hidden");
      $("gamification-section").classList.add("hidden");
      $("recommendations-section").classList.add("hidden");
    }
  });

  // Sign up
  $("btn-signup").addEventListener("click", async () => {
    try {
      const email = $("signup-email").value.trim();
      const password = $("signup-password").value;
      if (!email || !password) { alert("Email + password required"); return; }
      
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      idTokenCache = await cred.user.getIdToken();
      localStorage.setItem("idToken", idTokenCache);

      const res = await api("/register", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          name: $("signup-name").value || "",
          date_of_birth: $("signup-dob").value || "",
          gender: $("signup-gender").value || "",
          phone_number: $("signup-phone").value || "",
          country: $("signup-country").value || "",
          school_type: $("signup-school-type").value || "",
          school_name: $("signup-school-name").value || "",
          degree: $("signup-degree").value || "",
          course_of_study: $("signup-course").value || "",
          subject: $("signup-subject").value || ""
        })
      });
      logBackend(res);
      if (res.ok) alert("‚úÖ Account created!");
    } catch (err) {
      logBackend({ error: err.message });
      alert("Signup error: " + err.message);
    }
  });

  // Login
  $("btn-login").addEventListener("click", async () => {
    try {
      const email = $("login-email").value.trim();
      const password = $("login-password").value;
      const cred = await signInWithEmailAndPassword(auth, email, password);
      idTokenCache = await cred.user.getIdToken();
      localStorage.setItem("idToken", idTokenCache);
    } catch (err) {
      logBackend({ error: err.message });
      alert("Login error: " + err.message);
    }
  });

  // Google Sign In
  $("btn-google").addEventListener("click", async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      idTokenCache = await result.user.getIdToken();
      localStorage.setItem("idToken", idTokenCache);
      
      const res = await api("/register", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name: result.user.displayName || "" })
      });
      logBackend(res);
    } catch (err) {
      logBackend({ error: err.message });
    }
  });

  // Logout
  $("btn-logout").addEventListener("click", async () => { await signOut(auth); });
  $("btn-logout-top").addEventListener("click", async () => { await signOut(auth); });

    // Forgot Password
  $("btn-forgot").addEventListener("click", async () => {
    try {
      const email = $("forgot-email").value.trim();
      if (!email) {
        alert("Please enter your email to reset password.");
        return;
      }

      await sendPasswordResetEmail(auth, email);
      alert("‚úÖ Password reset email sent! Check your inbox.");
    } catch (err) {
      logBackend({ error: err.message });
      alert("Error: " + err.message);
    }
  });


  // Profile
  async function loadProfile() {
    const res = await api("/profile");
    if (res.ok && res.profile) {
      $("profile-name").value = res.profile.name || "";
      $("profile-dob").value = res.profile.date_of_birth || "";
      $("profile-gender").value = res.profile.gender || "";
      $("profile-phone").value = res.profile.phone_number || "";
      $("profile-country").value = res.profile.country || "";
      $("profile-school-type").value = res.profile.school_type || "";
      $("profile-school-name").value = res.profile.school_name || "";
      $("profile-degree").value = res.profile.degree || "";
      $("profile-course").value = res.profile.course_of_study || "";
      $("profile-subject").value = res.profile.subject || "";
      logBackend(res);
    }
  }

  $("btn-update-profile").addEventListener("click", async () => {
    const res = await api("/update_profile", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        name: $("profile-name").value,
        date_of_birth: $("profile-dob").value,
        gender: $("profile-gender").value,
        phone_number: $("profile-phone").value,
        country: $("profile-country").value,
        school_type: $("profile-school-type").value,
        school_name: $("profile-school-name").value,
        degree: $("profile-degree").value,
        course_of_study: $("profile-course").value,
        subject: $("profile-subject").value
      })
    });
    logBackend(res);
    if (res.ok) alert("‚úÖ Profile updated");
  });

  $("btn-delete-account").addEventListener("click", async () => {
    if (!confirm("‚ö†Ô∏è Delete your account permanently?")) return;
    const res = await api("/delete-account", { method:"DELETE" });
    logBackend(res);
    if (res.ok) { await signOut(auth); alert("Account deleted"); }
  });

  // Study session
  $("btn-start-session").addEventListener("click", () => {
    studyStart = new Date();
    $("study-status").textContent = "‚è±Ô∏è Session started: " + studyStart.toLocaleTimeString();
    $("btn-start-session").disabled = true;
    $("btn-end-session").disabled = false;
  });

  $("btn-end-session").addEventListener("click", async () => {
    if (!studyStart) return;
    const studyEnd = new Date();
    const diffMs = studyEnd - studyStart;
    const hours = diffMs / (1000*60*60);
    $("study-status").textContent = `‚úÖ Session ended. Duration: ${hours.toFixed(2)} hrs`;
    $("btn-start-session").disabled = false;
    $("btn-end-session").disabled = true;
    studyStart = null;

    const res = await api("/log_activity", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ session_hours: hours })
    });
    logBackend(res);
    if (res.ok) alert("üìä Study session logged!");
  });

  // Performance Prediction
  $("btn-predict-performance").addEventListener("click", async () => {
    $("btn-predict-performance").disabled = true;
    $("btn-predict-performance").textContent = "Analyzing...";
    
    const res = await api("/predict_performance");
    logBackend(res);
    
    $("btn-predict-performance").disabled = false;
    $("btn-predict-performance").textContent = "Predict My Performance";
    
    if (res.error) {
      alert("Prediction error: " + res.error);
      return;
    }
    
    const resultDiv = $("prediction-result");
    const isPassing = res.prediction === 1;
    resultDiv.innerHTML = `
      <div class="prediction-card ${isPassing ? 'prediction-pass' : 'prediction-fail'}">
        <h3>${isPassing ? 'üéâ Predicted: PASS' : 'üìä Predicted: Room for Improvement'}</h3>
        <p><strong>Confidence:</strong> ${res.confidence.toFixed(2)}%</p>
        <p>${res.message}</p>
        <details style="margin-top:12px;">
          <summary style="cursor:pointer; font-weight:500;">View Analysis Data</summary>
          <pre style="background:white; padding:8px; border-radius:4px; margin-top:8px; font-size:11px;">${JSON.stringify(res.ml_input, null, 2)}</pre>
        </details>
      </div>
    `;
  });

  // Gamification
  async function loadGamification() {
    if (!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    const res = await api(`/gamification/${uid}`);
    if (res.error) {
      logBackend(res);
      return;
    }
    
    const stats = res.gamification || {};
    const statsDiv = $("gamification-stats");
    statsDiv.innerHTML = `
      <div class="stats-card">
        <h3 style="margin:0 0 12px 0;">Level ${stats.level || 1}</h3>
        <div style="font-size:24px; margin:8px 0;">üî• ${stats.streak || 0} day streak</div>
        <div style="font-size:14px;">Longest: ${stats.longest_streak || 0} days</div>
        <div style="margin-top:12px;">
          ${(stats.badges || []).map(b => `<span class="badge badge-warning">${b}</span>`).join('')}
          ${(stats.badges || []).length === 0 ? '<div style="font-size:13px; opacity:0.8;">No badges yet - keep studying!</div>' : ''}
        </div>
      </div>
    `;
  }

  $("btn-refresh-gamification").addEventListener("click", loadGamification);

// Load reminders
async function loadReminders() {
  const res = await api("/get_reminders");
  if (!res.ok) { logBackend(res); return; }
  
  const list = $("reminder-list");
  list.innerHTML = "";
  
  if (!res.reminders || res.reminders.length === 0) {
    list.innerHTML = "<div style='color:#666; padding:12px;'>No reminders yet</div>";
    return;
  }
  
  res.reminders.forEach(r => {
    const div = document.createElement("div");
    div.className = `reminder-item ${r.completed ? 'completed' : ''}`;
    
    // üß© Show attached files
    let filesHtml = "";
    if (r.files && r.files.length > 0) {
      filesHtml = `
        <div style="margin-top:6px; font-size:13px;">
          üìé Files: ${r.files.map(f => `<a href="${f.url}" target="_blank">${escapeHtml(f.name)}</a>`).join(", ")}
        </div>`;
    }
    
    // üìö Study Plan Dropdown
    let studyPlanHtml = "";
    if (r.study_plan && Array.isArray(r.study_plan) && r.study_plan.length > 0) {
      studyPlanHtml = `
        <details style="margin-top:10px; border:1px solid #e0e0e0; border-radius:6px; padding:8px; background:#f9f9f9;">
          <summary style="cursor:pointer; font-weight:600; color:#333; user-select:none; outline:none; padding:4px;">
            üìñ Study Plan (${r.study_plan.length} days)
          </summary>
          <div style="margin-top:10px; padding:8px; background:#fff; border-radius:4px;">
            ${r.study_plan.map(day => `
              <div style="margin-bottom:12px; padding:8px; border-left:3px solid #4CAF50; background:#f8f9fa;">
                <strong style="color:#2e7d32; font-size:14px;">üìÖ Day ${escapeHtml(String(day.day))}</strong>
                <ul style="margin:6px 0 0 20px; padding:0; list-style-type:disc;">
                  ${day.topics && Array.isArray(day.topics) 
                    ? day.topics.map(topic => `<li style="margin:4px 0; font-size:13px; color:#555;">${escapeHtml(topic)}</li>`).join("") 
                    : '<li style="color:#999;">No topics listed</li>'}
                </ul>
              </div>
            `).join("")}
          </div>
        </details>`;
    }
    
    div.innerHTML = `
      <strong>${escapeHtml(r.title)}</strong>
      <div style="font-size:13px; color:#666; margin:4px 0;">
        üìÖ Due: ${escapeHtml(r.due_date)} ${r.completed ? '‚úÖ Completed' : ''}
      </div>
      ${r.description ? `<div style="font-size:13px; margin:4px 0;">${escapeHtml(r.description)}</div>` : ''}
      ${filesHtml}
      ${studyPlanHtml}
      <div style="margin-top:8px;">
        ${!r.completed ? `<button data-complete="${r.id}" class="small success">Complete</button>` : ''}
        <button data-delete="${r.id}" class="small danger">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
  
  list.querySelectorAll("button[data-complete]").forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute("data-complete");
      await api(`/reminders/${id}/complete`, { method: "POST" });
      loadReminders();
    };
  });
  
  list.querySelectorAll("button[data-delete]").forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute("data-delete");
      if (!confirm("Delete reminder?")) return;
      await api(`/reminders/${id}`, { method: "DELETE" });
      loadReminders();
    };
  });
}

  $("library-upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const title = $("library-title").value.trim();
    const files = $("library-files").files;
    
    if (!title || files.length === 0) {
      alert("Title and at least one file required");
      return;
    }
    
    const formData = new FormData();
    formData.append("title", title);
    for (let f of files) {
      formData.append("files", f);
    }
    
    const uid = auth.currentUser ? auth.currentUser.uid : "";
    if (!uid) {
      alert("Please sign in first");
      return;
    }
    
    try {
      $("chat-status").textContent = "Uploading documents...";
      
      const res = await fetch(`/library/${uid}`, {
        method: "POST",
        headers: { 
          "Authorization": "Bearer " + (localStorage.getItem("idToken") || "") 
        },
        body: formData
      });
      
      const result = await res.json();
      logBackend(result);
      
      if (result.error) {
        alert("Upload error: " + result.error);
      } else {
        alert("‚úÖ Documents uploaded successfully!");
        $("library-upload-form").reset();
        loadLibrary();
      }
    } catch (err) {
      alert("Upload failed: " + err.message);
    }
    
    $("chat-status").textContent = "";
  });

  // Load library documents
// Load library documents
  async function loadLibrary() {
    const uid = auth.currentUser ? auth.currentUser.uid : "";
    if (!uid) return;
    
    const res = await api(`/library/${uid}`);
    if (res.error) {
      logBackend(res);
      return;
    }
    
    const listDiv = $("library-list");
    listDiv.innerHTML = "";
    
    if (!res.library || res.library.length === 0) {
      listDiv.innerHTML = "<div style='color:#666; text-align:center; padding:20px;'>No documents yet</div>";
      return;
    }
    
    res.library.forEach(item => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "library-item";
      
      const filesHtml = (item.files || []).map((f, idx) => {
        const fileType = f.extension || f.type || 'file';
        const fileIcon = getFileIcon(f.name);
        const canPreview = f.extension && ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'webp'].includes(f.extension.toLowerCase());
        
        return `
          <div style="display:inline-block; margin:4px 4px 4px 0;">
            ${canPreview ? `
              <button onclick="window.viewFile('${escapeHtml(f.url)}', '${escapeHtml(f.name)}', '${escapeHtml(f.extension)}')" 
                      class="file-link" style="border:none; cursor:pointer;">
                ${fileIcon} ${escapeHtml(f.name)}
                <span class="file-type-badge">${escapeHtml(fileType)}</span>
              </button>
            ` : `
              <a href="${escapeHtml(f.url)}" target="_blank" class="file-link">
                ${fileIcon} ${escapeHtml(f.name)}
                <span class="file-type-badge">${escapeHtml(fileType)}</span>
              </a>
            `}
          </div>
        `;
      }).join('');
      
      const createdDate = item.created_at ? 
        new Date(item.created_at._seconds * 1000).toLocaleDateString() : 
        'N/A';
      
      itemDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="flex:1;">
            <h4 style="margin:0 0 4px 0;">${escapeHtml(item.title)}</h4>
            <div style="font-size:12px; color:#666;">
              üìÖ ${createdDate} ‚Ä¢ ${(item.files || []).length} file(s)
            </div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-update-library="${item.id}" class="small">Edit</button>
            <button data-delete-library="${item.id}" class="small danger">Delete</button>
          </div>
        </div>
        <div style="margin-top:8px;">
          ${filesHtml}
        </div>
      `;
      
      listDiv.appendChild(itemDiv);
    });
    
    // Delete and update handlers (same as before)
    listDiv.querySelectorAll("button[data-delete-library]").forEach(btn => {
      btn.onclick = async () => {
        const docId = btn.getAttribute("data-delete-library");
        if (!confirm("Delete this document?")) return;
        
        const delRes = await api(`/library_delete/${uid}/${docId}`, { 
          method: "DELETE" 
        });
        logBackend(delRes);
        
        if (delRes.ok) {
          alert("‚úÖ Document deleted");
          loadLibrary();
        } else {
          alert("Delete failed: " + (delRes.error || "Unknown error"));
        }
      };
    });
    
    listDiv.querySelectorAll("button[data-update-library]").forEach(btn => {
      btn.onclick = () => {
        const docId = btn.getAttribute("data-update-library");
        showUpdateLibraryModal(docId, res.library.find(i => i.id === docId));
      };
    });
  }

  // Add file viewer function
  window.viewFile = function(url, name, extension) {
    const ext = extension.toLowerCase();
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    `;
    
    const header = document.createElement('div');
    header.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    `;
    header.innerHTML = `
      <span style="font-weight: 500;">${escapeHtml(name)}</span>
      <div>
        <a href="${url}" download style="color: white; text-decoration: none; margin-right: 16px;">üì• Download</a>
        <button onclick="this.closest('div').parentElement.remove()" 
                style="background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          ‚úï Close
        </button>
      </div>
    `;
    
    const viewer = document.createElement('div');
    viewer.style.cssText = `
      width: 90%;
      height: 90%;
      background: white;
      border-radius: 8px;
      overflow: auto;
      margin-top: 60px;
    `;
    
    if (ext === 'pdf') {
      viewer.innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>`;
    } else if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
      viewer.innerHTML = `<img src="${url}" style="max-width:100%; max-height:100%; display:block; margin:auto;">`;
    }
    
    modal.appendChild(header);
    modal.appendChild(viewer);
    document.body.appendChild(modal);
    
    // Close on escape key
    document.addEventListener('keydown', function closeOnEscape(e) {
      if (e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', closeOnEscape);
      }
    });
  };

  // Helper: Get file icon based on extension
  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
      'pdf': 'üìÑ',
      'docx': 'üìù',
      'doc': 'üìù',
      'pptx': 'üìä',
      'ppt': 'üìä',
      'xlsx': 'üìà',
      'xls': 'üìà',
      'txt': 'üìÉ',
      'png': 'üñºÔ∏è',
      'jpg': 'üñºÔ∏è',
      'jpeg': 'üñºÔ∏è',
    };
    return icons[ext] || 'üìé';
  }

  // Show modal for updating library item
// Show modal for updating library item
  function showUpdateLibraryModal(docId, item) {
    const newTitle = prompt("Enter new title (leave empty to keep current):", item.title);
    if (newTitle === null) return; // User cancelled
    
    const shouldAddFiles = confirm("Do you want to add more files to this document?");
    
    if (!newTitle && !shouldAddFiles) {
      alert("No updates provided");
      return;
    }
    
    // Create a temporary form for file selection if needed
    if (shouldAddFiles) {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = '.pdf,.docx,.pptx,.xlsx,.txt,.png,.jpg,.jpeg';
      
      input.onchange = async () => {
        const overlay = createUploadOverlay();
        
        try {
          const formData = new FormData();
          if (newTitle) formData.append("title", newTitle);
          
          for (let f of input.files) {
            formData.append("files", f);
          }
          
          updateUploadProgress(20, "Updating document...");
          
          const uid = auth.currentUser.uid;
          
          // Use XMLHttpRequest for progress tracking
          const xhr = new XMLHttpRequest();
          
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 80;
              updateUploadProgress(20 + percentComplete, `Uploading... ${Math.round(percentComplete)}%`);
            }
          });
          
          xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
              updateUploadProgress(100, "Update complete! ‚úì");
              const result = JSON.parse(xhr.responseText);
              logBackend(result);
              
              setTimeout(() => {
                removeUploadOverlay();
                if (result.ok) {
                  alert("‚úÖ Document updated");
                  loadLibrary();
                } else {
                  alert("Update failed: " + (result.error || "Unknown error"));
                }
              }, 800);
            } else {
              removeUploadOverlay();
              alert("Update failed");
            }
          });
          
          xhr.addEventListener('error', () => {
            removeUploadOverlay();
            alert("Network error during update");
          });
          
          xhr.open('PUT', `/library_update/${uid}/${docId}`);
          xhr.setRequestHeader('Authorization', 'Bearer ' + (localStorage.getItem("idToken") || ""));
          xhr.send(formData);
          
        } catch (err) {
          removeUploadOverlay();
          alert("Update failed: " + err.message);
        }
      };
      
      input.click();
    } else if (newTitle) {
      // Just update title (quick operation, no progress needed)
      updateLibraryTitle(docId, newTitle);
    }
  }
  // Load Summaries
async function loadSummaries() {
  const res = await api("/get_summaries");
  if (res.error) { logBackend(res); return; }
  
  const container = $("summaries-container");
  container.innerHTML = "";
  
  if (!res.summaries || res.summaries.length === 0) {
    container.innerHTML = "<div style='color:#666; text-align:center; padding:20px;'>No summaries yet</div>";
    return;
  }
  
  res.summaries.forEach((item, idx) => {
    const summaryDiv = document.createElement("div");
    summaryDiv.className = "summary-item";
    summaryDiv.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h4 style="margin:0;">Summary ${idx + 1}</h4>
        <button data-delete-summary="${item.id}" class="small danger">Delete</button>
      </div>
      <div style="font-size:12px; color:#666; margin-bottom:8px;">Created: ${item.created_at || 'N/A'}</div>
      <div style="padding:10px; background:#f9f9f9; border-radius:4px; max-height:300px; overflow-y:auto;">
        ${escapeHtml(item.summary)}
      </div>
    `;
    container.appendChild(summaryDiv);
  });
  
  // Delete handlers
  container.querySelectorAll("button[data-delete-summary]").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-delete-summary");
      if (!confirm("Delete this summary?")) return;
      const delRes = await api(`/delete_summaries/${id}`, { method: "DELETE" });
      logBackend(delRes);
      if (delRes.ok) loadSummaries();
    };
  });
}

$("btn-refresh-summaries").addEventListener("click", loadSummaries);

  // Update only title
  async function updateLibraryTitle(docId, newTitle) {
    const formData = new FormData();
    formData.append("title", newTitle);
    
    const uid = auth.currentUser.uid;
    const res = await fetch(`/library_update/${uid}/${docId}`, {
      method: "PUT",
      headers: { 
        "Authorization": "Bearer " + (localStorage.getItem("idToken") || "") 
      },
      body: formData
    });
    
    const result = await res.json();
    logBackend(result);
    
    if (result.ok) {
      alert("‚úÖ Title updated");
      loadLibrary();
    } else {
      alert("Update failed: " + (result.error || "Unknown error"));
    }
  }

  // Refresh library button
  $("btn-refresh-library").addEventListener("click", loadLibrary);

  // Delete all library documents
  $("btn-delete-all-library").addEventListener("click", async () => {
    if (!confirm("‚ö†Ô∏è Delete ALL documents in your library? This cannot be undone!")) return;
    
    const uid = auth.currentUser ? auth.currentUser.uid : "";
    if (!uid) return;
    
    const res = await api(`/library/${uid}`, { method: "DELETE" });
    logBackend(res);
    
    if (res.ok) {
      alert("‚úÖ All documents deleted");
      loadLibrary();
    } else {
      alert("Delete failed: " + (res.error || "Unknown error"));
    }
  });

  // Navigation to library
  $("btn-go-library").addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior:'smooth' });
    $("library-section").scrollIntoView({ behavior: 'smooth' });
  });

// Add reminder
$("btn-add-reminder").addEventListener("click", async () => {
  const title = $("reminder-title").value.trim();
  const start = $("start-date").value;
  const due = $("reminder-date").value;
  const files = $("reminder-files").files;
  
  if (!start || !title || !due) {
    alert("Title, start date and due date required");
    return;
  }
  
  const formData = new FormData();
  formData.append("title", title);
  formData.append("due_date", due);
  formData.append("start_date", start);
  formData.append("description", $("reminder-desc").value || "");
  for (let f of files) formData.append("files", f);
  
  const res = await api("/reminders/study-plan", {
    method: "POST",
    body: formData
  });
  
  logBackend(res);
  if (res.ok) {
    $("reminder-title").value = "";
    $("reminder-desc").value = "";
    $("reminder-date").value = "";
    $("start-date").value = "";
    $("reminder-files").value = "";
    loadReminders();
    alert("‚úÖ Reminder created!");
  }
});

$("btn-refresh-reminders").addEventListener("click", loadReminders);




  // Recommendations
  $("btn-get-recommendations").addEventListener("click", async () => {
    $("btn-get-recommendations").disabled = true;
    $("btn-get-recommendations").textContent = "Loading...";
    
    const res = await api("/recommendations");
    logBackend(res);
    
    $("btn-get-recommendations").disabled = false;
    $("btn-get-recommendations").textContent = "Get Video Recommendations";
    
    if (res.error) {
      alert("Error: " + res.error);
      return;
    }
    
    const listDiv = $("recommendations-list");
    listDiv.innerHTML = "";
    
    if (!res.recommendations || res.recommendations.length === 0) {
      listDiv.innerHTML = "<div style='color:#666; padding:12px;'>No recommendations found</div>";
      return;
    }
    
    res.recommendations.forEach(rec => {
      const card = document.createElement("div");
      card.className = "video-card";
      card.innerHTML = `
        <h4 style="margin:0 0 8px 0;">${escapeHtml(rec.title)}</h4>
        <p style="font-size:13px; color:#666; margin:8px 0;">${escapeHtml(rec.reason || 'Recommended for you')}</p>
        <a href="${escapeHtml(rec.url)}" target="_blank" style="color:#007cba; text-decoration:none; font-weight:500;">
          üé¨ Watch Video ‚Üí
        </a>
      `;
      listDiv.appendChild(card);
    });
  });

  // Audio Recording
  $("btn-start-recording").addEventListener("click", async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Audio recording not supported");
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        await sendAudioMessage(audioBlob);
      };

      mediaRecorder.start();
      $("btn-start-recording").disabled = true;
      $("btn-stop-recording").disabled = false;
      $("recording-status").textContent = "üé§ Recording...";
    } catch (error) {
      alert("Microphone access error: " + error.message);
    }
  });

  $("btn-stop-recording").addEventListener("click", () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      $("btn-start-recording").disabled = false;
      $("btn-stop-recording").disabled = true;
      $("recording-status").textContent = "Processing...";
    }
  });

  async function sendAudioMessage(audioBlob) {
    if (!currentSessionId) { 
      alert("Create or load a session first"); 
      return; 
    }
    
    const formData = new FormData();
    formData.append('audio', audioBlob, 'audio.wav');

    try {
      const res = await fetch(`/chat_audio/${currentSessionId}`, {
        method: 'POST',
        headers: { "Authorization": "Bearer " + (localStorage.getItem("idToken")||"") },
        body: formData
      });

      const result = await res.json();
      logBackend(result);

      if (result.error) {
        alert("Audio error: " + result.error);
        return;
      }

      const cont = $("messages-container");
      
      const userDiv = document.createElement("div");
      userDiv.className = "message user";
      userDiv.innerHTML = `<div>üé§ ${escapeHtml(result.transcription)}</div>`;
      cont.appendChild(userDiv);

      const aiDiv = document.createElement("div");
      aiDiv.className = "message assistant";
      aiDiv.innerHTML = `<div>${escapeHtml(result.answer)}</div>`;
      cont.appendChild(aiDiv);

      cont.scrollTop = cont.scrollHeight;
      $("recording-status").textContent = "";

    } catch (error) {
      alert("Audio upload failed: " + error.message);
      $("recording-status").textContent = "";
    }
  }

  // Chat Sessions
  async function createNewSession() {
    const res = await api("/create_chat_session", { method:"POST" });
    if (!res.session_id) { 
      alert("Failed to create session"); 
      logBackend(res); 
      return; 
    }
    const session = { 
      id: res.session_id, 
      title: res.title || "New Chat", 
      created_at: new Date().toISOString() 
    };
    addLocalSession(session);
    return session;
  }

  $("btn-new-session").addEventListener("click", async () => {
    const s = await createNewSession();
    if (s) {
      currentSessionId = s.id;
      $("chat-status").textContent = "‚úÖ New session: " + currentSessionId.slice(0,16);
      $("messages-container").innerHTML = "";
    }
  });

  $("btn-load-session").addEventListener("click", async () => {
    const id = $("load-session-id").value.trim();
    if (!id) { alert("Paste session ID"); return; }
    loadSessionById(id);
  });

  async function loadSessionById(id) {
    currentSessionId = id;
    const res = await api("/chat/get-history", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ session_id: id })
    });
    
    if (res.error) { 
      alert("Failed to load: " + res.error); 
      return; 
    }
    
    addLocalSession({ 
      id, 
      title: res.title || "Loaded Session", 
      created_at: new Date().toISOString() 
    });
    
    await renderMessagesFromHistory(res.messages || []);
    $("chat-status").textContent = "‚úÖ Loaded: " + id.slice(0,16);
  }

  async function renderMessagesFromHistory(messages) {
    const container = $("messages-container");
    container.innerHTML = "";
    messages.forEach(m => {
      const div = document.createElement("div");
      div.className = "message " + (m.role === "user" ? "user" : "assistant");
      div.innerHTML = `<div>${escapeHtml(m.content)}</div>`;
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }

  $("btn-clear-memory").addEventListener("click", async () => {
    if (!currentSessionId) { alert("No session loaded"); return; }
    if (!confirm("Clear all messages in this session?")) return;
    
    const res = await api("/chat/clear-memory", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ session_id: currentSessionId })
    });
    logBackend(res);
    
    if (res.ok) {
      $("messages-container").innerHTML = "";
      alert("‚úÖ Memory cleared");
    }
  });

  // Send message
  async function sendMessage(text) {
    if (!currentSessionId) { 
        alert("Create or load a session first"); 
        return; 
    }
    
    const cont = $("messages-container");

    // Show user's message
    const userDiv = document.createElement("div");
    userDiv.className = "message user";
    userDiv.innerHTML = `<div>${escapeHtml(text)}</div>`;
    cont.appendChild(userDiv);
    cont.scrollTop = cont.scrollHeight;

    // Create assistant message container
    const aiDiv = document.createElement("div");
    aiDiv.className = "message assistant";
    const messageContent = document.createElement("div");
    messageContent.className = "message-content";
    aiDiv.appendChild(messageContent);
    cont.appendChild(aiDiv);

    // Send request to backend
    const res = await api(`/chat/${currentSessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    });

    logBackend(res);

    // Handle errors
    if (res.error) {
        messageContent.innerHTML = `<p style="color:#ff6b6b">Error: ${escapeHtml(res.error)}</p>`;
        return;
    }

    // Format and display response with typewriter effect
    const formattedResponse = parseAndFormatMessage(res.response);
    await typewriterEffect(messageContent, formattedResponse);

    // Add audio controls container
    const audioContainer = document.createElement("div");
    audioContainer.className = "audio-controls";
    audioContainer.style.cssText = "margin-top: 12px; display: flex; gap: 8px; align-items: center;";
    
    const playBtn = document.createElement("button");
    playBtn.className = "small";
    playBtn.innerHTML = "üîä Play Audio";
    playBtn.disabled = true;
    
    const stopBtn = document.createElement("button");
    stopBtn.className = "small danger";
    stopBtn.innerHTML = "‚èπ Stop";
    stopBtn.disabled = true;
    stopBtn.style.display = "none";
    
    const refreshBtn = document.createElement("button");
    refreshBtn.className = "small secondary";
    refreshBtn.innerHTML = "üîÑ Refresh Audio";
    refreshBtn.disabled = true;
    refreshBtn.style.display = "none";
    
    const statusSpan = document.createElement("span");
    statusSpan.className = "audio-status";
    statusSpan.style.cssText = "font-size: 12px; color: #666;";
    statusSpan.textContent = "Loading audio...";
    
    audioContainer.appendChild(playBtn);
    audioContainer.appendChild(stopBtn);
    audioContainer.appendChild(refreshBtn);
    audioContainer.appendChild(statusSpan);
    aiDiv.appendChild(audioContainer);
    
    cont.scrollTop = cont.scrollHeight;

    // Store audio element reference
    let currentAudio = null;

    // Audio generation and control
    const generateAudio = async () => {
        statusSpan.textContent = "Generating audio...";
        playBtn.disabled = true;
        refreshBtn.disabled = true;
        
        try {
            const audioRes = await api(`/chat/${currentSessionId}/audio`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: res.response })
            });

            if (audioRes.error) {
                statusSpan.textContent = "Audio unavailable";
                statusSpan.style.color = "#ff6b6b";
                return;
            }

            if (audioRes.audio) {
                const mime = audioRes.mime_type || "audio/wav";
                currentAudio = new Audio(`data:${mime};base64,${audioRes.audio}`);
                
                currentAudio.onended = () => {
                    playBtn.innerHTML = "üîä Play Audio";
                    playBtn.disabled = false;
                    stopBtn.disabled = true;
                    stopBtn.style.display = "none";
                    statusSpan.textContent = "";
                };
                
                currentAudio.onerror = () => {
                    statusSpan.textContent = "Playback failed";
                    statusSpan.style.color = "#ff6b6b";
                    playBtn.disabled = false;
                    stopBtn.disabled = true;
                };
                
                playBtn.disabled = false;
                refreshBtn.disabled = false;
                refreshBtn.style.display = "inline-block";
                statusSpan.textContent = "Ready";
                statusSpan.style.color = "#28a745";
            }
        } catch (err) {
            statusSpan.textContent = "Audio generation failed";
            statusSpan.style.color = "#ff6b6b";
        }
    };
    
    // Play button handler
    playBtn.onclick = () => {
        if (currentAudio) {
            currentAudio.play().catch(err => {
                statusSpan.textContent = "Playback error";
                statusSpan.style.color = "#ff6b6b";
            });
            playBtn.innerHTML = "‚è∏ Pause";
            const originalHandler = playBtn.onclick;
            playBtn.onclick = () => {
                currentAudio.pause();
                playBtn.innerHTML = "üîä Resume";
                playBtn.onclick = originalHandler;
            };
            stopBtn.disabled = false;
            stopBtn.style.display = "inline-block";
            statusSpan.textContent = "Playing...";
        }
    };
    
    // Stop button handler
    stopBtn.onclick = () => {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            playBtn.innerHTML = "üîä Play Audio";
            stopBtn.disabled = true;
            stopBtn.style.display = "none";
            statusSpan.textContent = "Stopped";
        }
    };
    
    // Refresh button handler
    refreshBtn.onclick = () => {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }
        playBtn.disabled = true;
        stopBtn.disabled = true;
        stopBtn.style.display = "none";
        refreshBtn.disabled = true;
        generateAudio();
    };

    // Initial audio generation
    generateAudio();
  }

  // New function to fetch audio asynchronously
  async function fetchAudioForMessage(text, buttonElement) {
    try {
      const audioRes = await api(`/chat/${currentSessionId}/audio`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text })
      });

      if (audioRes.error) {
        console.error("Audio generation failed:", audioRes.error);
        buttonElement.textContent = "‚ùå Audio unavailable";
        buttonElement.disabled = true;
        return;
      }

      if (audioRes.audio) {
        // Audio ready - update button
        buttonElement.textContent = "üîä Play Audio";
        buttonElement.disabled = false;
        
        const mime = audioRes.mime_type || "audio/wav";
        buttonElement.onclick = () => {
          const audio = new Audio(`data:${mime};base64,${audioRes.audio}`);
          audio.play().catch(err => {
            console.warn("Playback failed:", err);
            alert("Audio playback failed");
          });
        };
      } else {
        buttonElement.textContent = "‚ùå No audio generated";
        buttonElement.disabled = true;
      }
    } catch (err) {
      console.error("Audio fetch error:", err);
      buttonElement.textContent = "‚ùå Audio failed";
      buttonElement.disabled = true;
    }
  }


  $("btn-send").addEventListener("click", async () => {
    const text = $("message-input").value.trim();
    if (!text) return;
    $("message-input").value = "";
    await sendMessage(text);
  });

  $("message-input").addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      e.preventDefault();
      $("btn-send").click();
    }
  });

// PDF Summary
  $("pdf-summary-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    $("chat-status").textContent = "Uploading PDF...";
    
    try {
      const res = await fetch("/media_summary", { 
        method:"POST", 
        body: fd, 
        headers: { "Authorization": "Bearer " + (localStorage.getItem("idToken")||"") }
      });
      const jr = await res.json();
      logBackend(jr);
      
      if (jr.error) {
        alert("PDF error: " + jr.error);
      } else {
        alert("‚úÖ Summary generated!");
        loadSummaries(); // ‚úÖ FIX: Load summaries instead of adding to chat
      }
    } catch (err) { 
      alert("Upload failed: " + err.message); 
    }
    
    $("chat-status").textContent = "";
    form.reset();
  });

  // PDF Quiz
  $("pdf-quiz-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    $("chat-status").textContent = "Generating quiz...";
    
    try {
      const res = await fetch("/media_quiz", { 
        method:"POST", 
        body: fd, 
        headers: { "Authorization": "Bearer " + (localStorage.getItem("idToken")||"") }
      });
      const jr = await res.json();
      logBackend(jr);
      
      if (jr.error) {
        alert("Quiz error: " + jr.error);
      } else {
        alert("‚úÖ Quiz generated!");
        loadQuizzes();
      }
    } catch (err) { 
      alert("Upload failed: " + err.message); 
    }
    
    $("chat-status").textContent = "";
    form.reset();
  });

  // Media Flashcards
  $("pdf-flashcard-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const fd = new FormData(form);

    $("chat-status").textContent = "Generating flashcards... ‚è≥";

    try {
      const res = await fetch("/media_flashcards", {
        method: "POST",
        body: fd,
        headers: {
          "Authorization": "Bearer " + (localStorage.getItem("idToken") || "")
        }
      });

      const jr = await res.json();
      logBackend(jr);

      if (jr.error) {
        alert("‚ö†Ô∏è Flashcard error: " + jr.error);
      } else {
        alert("‚úÖ Flashcards generated successfully!");
        loadFlashcards();
      }
    } catch (err) {
      alert("‚ùå Upload failed: " + err.message);
    }

    $("chat-status").textContent = "";
    form.reset();
  });


  // Text to Quiz
  $("quiz-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = $("quiz-input").value.trim();
    if (!text) return;
    
    $("chat-status").textContent = "Generating quiz...";
    const res = await api("/chat_quiz", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
    
    logBackend(res);
    if (res.error) {
      alert("Quiz error: " + res.error);
    } else {
      alert("‚úÖ Quiz generated!");
      loadQuizzes();
    }
    
    $("quiz-input").value = "";
    $("chat-status").textContent = "";
  });

  // Text to Flashcards
  $("flashcard-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = $("flashcard-input").value.trim();
    if (!text) return;
    
    $("chat-status").textContent = "Generating flashcards...";
    const res = await api("/chat_flashcards", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
    
    logBackend(res);
    if (res.error) {
      alert("Flashcard error: " + res.error);
    } else {
      alert("‚úÖ Flashcards generated!");
      loadFlashcards();
    }
    
    $("flashcard-input").value = "";
    $("chat-status").textContent = "";
  });

 
// Load Flashcards
  async function loadFlashcards() {
    const res = await api("/get_flashcards");
    if (res.error) { logBackend(res); return; }
    
    const container = $("flashcards-container");
    container.innerHTML = "";
    
    if (!res.flashcards || res.flashcards.length === 0) {
      container.innerHTML = "<div style='color:#666; text-align:center; padding:20px;'>No flashcards yet</div>";
      return;
    }
    
    res.flashcards.forEach((set, idx) => {
      const setDiv = document.createElement("div");
      setDiv.className = "flashcard";
      setDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h4 style="margin:0;">Flashcard Set ${idx + 1}</h4>
          <div>
            <button data-delete-set="${set.id}" class="small danger">Delete</button>
          </div>
        </div>
        <div style="font-size:12px; color:#666; margin-bottom:12px;">Created: ${set.created_at || 'N/A'} ‚Ä¢ ${(set.flashcards || []).length} cards</div>
        <div class="flashcard-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;">
          ${(set.flashcards || []).map((card, cardIdx) => `
            <div class="flip-card" data-card-id="${idx}-${cardIdx}">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <div style="font-size:13px; color:#999; margin-bottom:8px;">Question ${cardIdx + 1}</div>
                  <div style="font-size:15px; font-weight:500;">${escapeHtml(card.question)}</div>
                  <div style="margin-top:12px; font-size:12px; color:#007cba;">üëÜ Tap to reveal answer</div>
                </div>
                <div class="flip-card-back">
                  <div style="font-size:13px; color:#999; margin-bottom:8px;">Answer ${cardIdx + 1}</div>
                  <div style="font-size:15px;">${escapeHtml(card.answer)}</div>
                  <div style="margin-top:12px; font-size:12px; color:#007cba;">üëÜ Tap to see question</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      container.appendChild(setDiv);
    });
    
    // Add click handlers for flipping cards
    container.querySelectorAll(".flip-card").forEach(card => {
      card.addEventListener("click", function() {
        this.classList.toggle("flipped");
      });
    });
    
    // Delete handlers
    container.querySelectorAll("button[data-delete-set]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-delete-set");
        if (!confirm("Delete flashcard set?")) return;
        const delRes = await api(`/flashcards/${id}`, { method: "DELETE" });
        logBackend(delRes);
        if (delRes.ok) loadFlashcards();
      };
    });
  }

// Navigation and shuffle functions
window.prevCard = function(setIdx) {
  const set = document.querySelectorAll(".flashcard-grid")[setIdx];
  if (!set) return;
  const cards = Array.from(set.children);
  set.prepend(cards.pop());
};

window.nextCard = function(setIdx) {
  const set = document.querySelectorAll(".flashcard-grid")[setIdx];
  if (!set) return;
  const cards = Array.from(set.children);
  set.append(cards.shift());
};

window.shuffleCards = function(setIdx) {
  const set = document.querySelectorAll(".flashcard-grid")[setIdx];
  if (!set) return;
  const cards = Array.from(set.children);
  for (let i = cards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [cards[i], cards[j]] = [cards[j], cards[i]];
  }
  set.innerHTML = "";
  cards.forEach(c => set.appendChild(c));
};


  $("btn-refresh-flashcards").addEventListener("click", loadFlashcards);

  // Load Quizzes
  async function loadQuizzes() {
    const res = await api("/get_chat_quiz");
    if (res.error) { logBackend(res); return; }
    
    const container = $("quiz-container");
    container.innerHTML = "";
    
    if (!res.quiz || res.quiz.length === 0) {
      container.innerHTML = "<div style='color:#666; text-align:center; padding:20px;'>No quizzes yet</div>";
      return;
    }
    
    res.quiz.forEach((set, idx) => {
      let quizData;
      try {
        quizData = typeof set.quiz === 'string' ? JSON.parse(set.quiz) : set.quiz;
      } catch (e) {
        quizData = [];
      }
      
      const setDiv = document.createElement("div");
      setDiv.className = "quiz-container";
      setDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h4 style="margin:0;">Quiz Set ${idx + 1}</h4>
          <div>
            <button data-take-quiz="${set.id}" class="small">Take Quiz</button>
            <button data-delete-quiz="${set.id}" class="small danger">Delete</button>
          </div>
        </div>
        <div style="font-size:12px; color:#666;">Created: ${set.created_at || 'N/A'}</div>
        <div style="font-size:12px; color:#666;">${Array.isArray(quizData) ? quizData.length : 0} questions</div>
      `;
      container.appendChild(setDiv);
    });
    
    container.querySelectorAll("button[data-take-quiz]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-take-quiz");
        const quiz = res.quiz.find(q => q.id === id);
        showQuiz(quiz);
      };
    });
    
    container.querySelectorAll("button[data-delete-quiz]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-delete-quiz");
        if (!confirm("Delete quiz?")) return;
        const delRes = await api(`/delete_quiz/${id}`, { method: "DELETE" });
        logBackend(delRes);
        if (delRes.ok) loadQuizzes();
      };
    });
  }

  function showQuiz(quiz) {
    let quizData;
    try {
      quizData = typeof quiz.quiz === 'string' ? JSON.parse(quiz.quiz) : quiz.quiz;
    } catch (e) {
      alert("Error parsing quiz");
      return;
    }
    
    if (!Array.isArray(quizData) || quizData.length === 0) {
      alert("No valid questions");
      return;
    }
    
    const container = $("quiz-container");
    let currentQuestion = 0;
    const userAnswers = {};
    
    function renderQuestion() {
      const q = quizData[currentQuestion];
      container.innerHTML = `
        <div style="border:2px solid #007cba; padding:16px; border-radius:8px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
            <h3 style="margin:0;">Question ${currentQuestion + 1}/${quizData.length}</h3>
            <button onclick="window.loadQuizzes()" class="small">Exit</button>
          </div>
          <div class="quiz-question">${escapeHtml(q.question || 'No question')}</div>
          <div style="margin-top:12px;">
            ${q.options ? Object.keys(q.options).map(key => `
              <div class="quiz-option">
                <input type="radio" name="answer" value="${key}" id="opt_${key}">
                <label for="opt_${key}">${key}) ${escapeHtml(q.options[key])}</label>
              </div>
            `).join('') : '<div style="color:#666;">No options</div>'}
          </div>
          <div style="margin-top:16px; display:flex; justify-content:space-between;">
            <button ${currentQuestion === 0 ? 'disabled' : ''} onclick="window.prevQuestion()" class="small">Previous</button>
            <button onclick="window.${currentQuestion === quizData.length - 1 ? 'finishQuiz' : 'nextQuestion'}()" class="small">
              ${currentQuestion === quizData.length - 1 ? 'Finish' : 'Next'}
            </button>
          </div>
        </div>
      `;
      
      if (userAnswers[currentQuestion]) {
        const radio = container.querySelector(`input[value="${userAnswers[currentQuestion]}"]`);
        if (radio) radio.checked = true;
      }
    }
    
    window.nextQuestion = function() {
      const selected = container.querySelector('input[name="answer"]:checked');
      if (selected) {
        userAnswers[currentQuestion] = selected.value;
        currentQuestion++;
        renderQuestion();
      } else {
        alert("Please select an answer");
      }
    };
    
    window.prevQuestion = function() {
      const selected = container.querySelector('input[name="answer"]:checked');
      if (selected) userAnswers[currentQuestion] = selected.value;
      currentQuestion--;
      renderQuestion();
    };
    
    window.finishQuiz = async function() {
      const selected = container.querySelector('input[name="answer"]:checked');
      if (selected) userAnswers[currentQuestion] = selected.value;
      
      let correct = 0;
      quizData.forEach((q, i) => {
        if (userAnswers[i] === q.answer) correct++;
      });
      
      const percentage = Math.round((correct / quizData.length) * 100);
      
      await api("/save_quiz_score", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          quiz_id: quiz.id,
          score: correct,
          total: quizData.length
        })
      });
      
      container.innerHTML = `
        <div class="quiz-results">
          <h3>üéâ Quiz Complete!</h3>
          <p><strong>Score: ${correct}/${quizData.length} (${percentage}%)</strong></p>
          <div style="margin-top:12px; max-height:300px; overflow-y:auto;">
            ${quizData.map((q, i) => `
              <div style="margin:8px 0; padding:10px; border-radius:4px; ${userAnswers[i] === q.answer ? 'background:#e8f5e8;' : 'background:#ffe8e8;'}">
                <strong>Q${i + 1}:</strong> ${escapeHtml(q.question)}<br>
                <strong>Your answer:</strong> ${userAnswers[i] || 'No answer'}<br>
                <strong>Correct:</strong> ${q.answer} ${userAnswers[i] === q.answer ? '‚úì' : '‚úó'}
              </div>
            `).join('')}
          </div>
          <button onclick="window.loadQuizzes()" style="margin-top:12px;">Back to Quizzes</button>
        </div>
      `;
    };
    
    window.loadQuizzes = loadQuizzes;
    renderQuestion();
  }

  $("btn-refresh-quiz").addEventListener("click", loadQuizzes);

  // Helper function
  function addAssistantMessage(txt) {
    const cont = $("messages-container");
    const aiDiv = document.createElement("div");
    aiDiv.className = "message assistant";
    aiDiv.innerHTML = `<div>${escapeHtml(txt)}</div>`;
    cont.appendChild(aiDiv);
    cont.scrollTop = cont.scrollHeight;
  }

  // Navigation helpers
  $("btn-go-chat").addEventListener("click", () => {
    document.querySelector('.tab[data-tab="chat"]').click();
    window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
  });

  $("btn-go-profile").addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior:'smooth' });
    $("profile-section").scrollIntoView({ behavior: 'smooth' });
  });

  // Initialize on load
  renderLocalSessions();
  
  // Auto-load data when signed in
  (async () => { 
    try { 
      if (localStorage.getItem("idToken")) { 
        await loadReminders(); 
        await loadProfile(); 
        await loadLibrary();
        loadSummaries();
        loadFlashcards();
        loadQuizzes();
        loadGamification();
      } 
    } catch(e) {
      console.error("Init error:", e);
    } 
  })();

  // ============================================
// MOBILE ENHANCEMENTS
// ============================================

// Prevent zoom on input focus (iOS)
function preventZoom() {
  const viewportMeta = document.querySelector('meta[name="viewport"]');
  if (viewportMeta) {
    const content = viewportMeta.getAttribute('content');
    const newContent = content.replace(/maximum-scale=[0-9.]+/, 'maximum-scale=1.0');
    viewportMeta.setAttribute('content', newContent);
  }
}

// Detect mobile device
function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Adjust UI for mobile on load
if (isMobile()) {
  document.body.classList.add('mobile-device');
  
  // Disable hover effects on mobile
  const style = document.createElement('style');
  style.textContent = `
    @media (hover: none) {
      *:hover {
        /* Disable problematic hover states */
      }
    }
  `;
  document.head.appendChild(style);
}

// Handle orientation changes
let previousOrientation = window.orientation;
window.addEventListener('orientationchange', () => {
  const currentOrientation = window.orientation;
  if (previousOrientation !== currentOrientation) {
    previousOrientation = currentOrientation;
    
    // Reload certain components on orientation change
    setTimeout(() => {
      if (document.querySelector('.tab.active[data-tab="flashcards"]')) {
        loadFlashcards();
      }
      if (document.querySelector('.tab.active[data-tab="images"]')) {
        loadImageGallery();
      }
    }, 100);
  }
});

// Smooth scroll to top button (mobile convenience)
function createScrollToTop() {
  const btn = document.createElement('button');
  btn.innerHTML = '‚¨ÜÔ∏è';
  btn.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: opacity 0.3s;
  `;
  
  btn.onclick = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  document.body.appendChild(btn);
  
  window.addEventListener('scroll', () => {
    if (window.scrollY > 300) {
      btn.style.display = 'block';
    } else {
      btn.style.display = 'none';
    }
  });
}

if (isMobile()) {
  createScrollToTop();
}

// Better touch handling for flip cards
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('touchstart', (e) => {
    if (e.target.closest('.flip-card')) {
      const card = e.target.closest('.flip-card');
      card.classList.toggle('flipped');
    }
  }, { passive: true });
});

  // Prevent double-tap zoom on buttons
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // Handle safe area for notched devices 
  if (CSS.supports('padding: env(safe-area-inset-top)')) {
    document.body.style.paddingTop = 'calc(16px + env(safe-area-inset-top))';
    document.body.style.paddingBottom = 'calc(16px + env(safe-area-inset-bottom))';
    document.body.style.paddingLeft = 'calc(16px + env(safe-area-inset-left))';
    document.body.style.paddingRight = 'calc(16px + env(safe-area-inset-right))';
  }

  // Log device info for debugging
  console.log('üì± Device Info:', {
    isMobile: isMobile(),
    screenWidth: window.innerWidth,
    screenHeight: window.innerHeight,
    devicePixelRatio: window.devicePixelRatio,
    orientation: window.orientation || screen.orientation?.type
  });

  </script>
</body>
</html>